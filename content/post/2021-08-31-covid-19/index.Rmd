---
title: 'COVID-19 Data '
author: Randi Bolt
date: '2021-08-31'
slug: covid-19
categories:
  - data
  - rstudio
tags:
  - rstudio
  - covid
  - data
  - census
draft: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
library(magrittr)
library(dplyr)
library(readr)
library(tidyr)
library(lubridate)
library(pander)
library(ggplot2)
library(scales) #percentages in tables
library(gt) #format tables
library(gridExtra) # grid.arrange
library(tidycensus) # population data
readRenviron("../../../.Renviron")
```

## Background and Data

COVID-19 is causing havoc in Oregon once again, and as numbers continue to spike, I decided to revisit one the of the first projects I worked on in R Studio. That project can be seen [here](https://rbolt13.github.io/rsite/covid.html), and used data from Johns Hopkins. However, because that data is no longer updated this investigation will use data from the NY times that has more current data. The repository for the NY Times data can be found [here](https://github.com/nytimes/covid-19-data), and the datasets that are being included are : 

1. **us.states** : state level data (file description [here](https://github.com/nytimes/covid-19-data/blob/master/README.md))

2. **us.counties** : county-level data (file description [here](https://github.com/nytimes/covid-19-data/blob/master/README.md))

3. **colleges** : number of reported cases among students and employees at American colleges and universities, updated May 26th (file description [here](https://github.com/nytimes/covid-19-data/tree/master/colleges))

4. **mask_use** : survey between July 2 and July 14 (2020) where participants were asked, _"How oftern do you wear a mask in public when you expect to be within six feet of another person?"_ (file description [here](https://github.com/nytimes/covid-19-data/tree/master/mask-use)) 

5. **vacc**: state level COVID-19 daily vaccination numbers time series data from the Johns Hopkins University repository (file description [here](https://github.com/govex/COVID-19/blob/master/data_tables/vaccine_data/us_data/readme.md))

6. **policytrackerOR**:  dates and description of policies going into/out of effect in Oregon.  To load data for a particular state go to [here](https://github.com/govex/COVID-19/tree/govex_data/data_tables/policy_data/table_data/Current), find the name of the state file you want to work with. 

Here is the data :

```{r load_data}
us.states <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv')
us.counties <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')
colleges <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/colleges/colleges.csv')
mask_use <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/colleges/colleges.csv')
vacc <- read_csv("https://raw.githubusercontent.com/govex/COVID-19/master/data_tables/vaccine_data/us_data/time_series/people_vaccinated_us_timeline.csv")
policytrackerOR <- read_csv("https://raw.githubusercontent.com/govex/COVID-19/govex_data/data_tables/policy_data/table_data/Current/Oregon_policy.csv")
```

Additionally this project will use population data from the tidycensus package which I discuss more about how I got this data in a blog post [here](https://rbolt.netlify.app/post/2021/08/30/tidycensus-package/). Note that this data is from 2019, which is a couple years older than the COVID data. 

```{r}
state.est <- get_estimates(geography = "state", year = 2019, variable = c("POP"))
or.county.est <- get_estimates(geography = "county", state = "OR", year = 2019, variable = c("POP"))
# pre clean to remove " County, Oregon" from the county name (this will make joining later easier)
or.county.est$NAME <- gsub(" County, Oregon", "", or.county.est$NAME )
head(state.est)
head(or.county.est)
```

# Wrangling the Data
The COVID data set is already in long form (meaning the dates are in rows instead of columns), and the date is already saved as a date variable. Therefore the main tasks here are to join the us.states data set with the vaccination records, and population estimates. Then join the us.states.vacc with the population data and create new percentage columns. 

```{r}
# states join with vacc
us.states.vacc <- us.states %>%
  select(date, state, cases, deaths) %>%
  full_join(vacc %>%
              select(Province_State, Date, Lat, Long_, People_Fully_Vaccinated, People_Partially_Vaccinated),
            by = c("state"="Province_State", "date"="Date")) %>%
  select(date, state, cases, deaths, People_Fully_Vaccinated, People_Partially_Vaccinated) %>% # join with census population data 
  full_join(state.est %>% 
              select(NAME, value),
            by = c("state"="NAME")) %>%
  summarise(date = date,
            state = state,
            population = value,
            cases = cases,
            perc.cases = cases/population,
            deaths = deaths,
            perc.deaths = deaths/population,
            full.vacc = People_Fully_Vaccinated,
            full.vacc.perc = full.vacc/population,
            part.vacc = People_Partially_Vaccinated,
            part.vacc.perc = part.vacc/population)
head(us.states.vacc, n=5)
```

Note: People_Fully_Vaccinated and People_Partially_Vaccinated show as NA because of the dates displayed were before the vaccine was released.

Next, to filter out Oregon from the counties data, and join with the population data per county. 
```{r}
# select only oregon counties, and join with population
or.covid.est <- us.counties %>%
  filter(state == "Oregon") %>%
  select(date, county, cases, deaths) %>%
  full_join(or.county.est %>%
              select(NAME, value),
            by = c("county"="NAME"))%>% 
  summarise(date = date,
            county = county,
            population = value,
            cases = cases,
            cases.perc = cases/population,
            deaths = deaths,
            deaths.perc = deaths/population) 
head(or.covid.est, n=10)
```

---

# Using the data
```{r}
# head(us.states.vacc %>%
#        filter(date == "2021-08-30") %>%
#   arrange(desc(perc.cases)), n=10)
# 
# us.states.vacc %>%
#   filter(date == "2021-08-30") %>%
#   arrange(!desc(full.vacc.perc)

or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(cases.perc))

or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(deaths.perc))
```


Next to look at the data for Oregon Counties, by filter the most recent date, which as of this being written is **August 30th, 2021**, and then look at the top five Oregon counties with :

* the highest number of cases

* the highest percentage of cases per county 

* the highest number of deaths

* the highest death percentage 

```{r}
# cases 
head(or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(cases)), n=5)
# case percentage
head(or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(cases.perc)), n=5)
# deaths
head(or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(deaths)), n=5)
# death percentage
head(or.covid.est %>%
  filter(date =="2021-08-30") %>%
  arrange(desc(deaths.perc)), n=5)
```

To do : make nice tables and make some notes
